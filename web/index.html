<!DOCTYPE html>
<html>
<head>
  <base href="/timesheetok/">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="TimeSheet App - Application de gestion des temps de travail avec scanner QR Code">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="TimeSheet App">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>TimeSheet App</title>
  <link rel="manifest" href="manifest.json">

  <!-- Configuration pour la caméra -->
  <meta name="permissions-policy" content="camera=*, microphone=*, geolocation=*">

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .loading-container {
      text-align: center;
    }

    .spinner {
      width: 80px;
      height: 80px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    h1 {
      margin: 0 0 10px 0;
      font-size: 2.5em;
    }

    p {
      margin: 0;
      font-size: 1.2em;
      opacity: 0.9;
    }

    .error {
      display: none;
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }

    .error button {
      background: white;
      color: #667eea;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      margin-top: 15px;
    }

    .error button:hover {
      background: #f0f0f0;
    }

    #flutter-app {
      display: none;
      width: 100%;
      height: 100vh;
    }
  </style>
</head>
<body>
  <!-- Écran de chargement -->
  <div id="loading" class="loading-container">
    <div class="spinner"></div>
    <h1>TimeSheet App</h1>
    <p>Chargement en cours...</p>
    
    <!-- Message d'erreur (caché par défaut) -->
    <div id="error" class="error">
      <h3>Erreur de chargement</h3>
      <p>L'application n'a pas pu démarrer. Vérifiez votre connexion internet et réessayez.</p>
      <button onclick="location.reload()">Réessayer</button>
    </div>
  </div>

  <!-- Conteneur Flutter (caché pendant le chargement) -->
  <div id="flutter-app"></div>

  <!-- Script Flutter avec chemins corrigés pour GitHub Pages -->
  <script src="flutter.js" defer></script>
  <script>
    // Configuration Flutter Web pour GitHub Pages
    window.addEventListener('load', function() {
      console.log('Page chargée, démarrage de Flutter...');
      
      // Délai de sécurité pour s'assurer que Flutter est prêt
      setTimeout(function() {
        try {
          // Vérifier que Flutter est disponible
          if (typeof _flutter !== 'undefined' && _flutter.loader) {
            console.log('Flutter détecté, démarrage...');
            
            // Démarrer Flutter avec configuration simple
            _flutter.loader.loadEntrypoint({
              serviceWorker: {
                serviceWorkerVersion: serviceWorkerVersion,
              },
              onEntrypointLoaded: function(engineInitializer) {
                console.log('Entrypoint chargé, initialisation...');
                
                engineInitializer.initializeEngine().then(function(appRunner) {
                  console.log('Moteur initialisé, démarrage de l\'app...');
                  
                  // Masquer le chargement et afficher l'app
                  document.getElementById('loading').style.display = 'none';
                  document.getElementById('flutter-app').style.display = 'block';
                  
                  // Démarrer l'application
                  appRunner.runApp();
                  
                  console.log('Application démarrée avec succès !');
                }).catch(function(error) {
                  console.error('Erreur lors de l\'initialisation du moteur:', error);
                  showError('Erreur lors de l\'initialisation du moteur');
                });
              }
            });
          } else {
            console.error('Flutter non détecté');
            showError('Flutter n\'est pas disponible');
          }
        } catch (error) {
          console.error('Erreur lors du démarrage:', error);
          showError('Erreur lors du démarrage de l\'application');
        }
      }, 2000); // Délai de 2 secondes pour GitHub Pages
    });

    // Fonction pour afficher les erreurs
    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      document.querySelector('#error p').textContent = message;
    }

    // Gestion des erreurs globales
    window.addEventListener('error', function(e) {
      console.error('Erreur JavaScript:', e.error);
      showError('Erreur JavaScript détectée');
    });

    // Gestion des promesses rejetées
    window.addEventListener('unhandledrejection', function(e) {
      console.error('Promesse rejetée:', e.reason);
      showError('Erreur de promesse détectée');
    });
  </script>
</body>
</html>
