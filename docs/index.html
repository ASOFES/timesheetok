<!DOCTYPE html>
<html>
<head>
  <base href="/timesheetok/">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="TimeSheet App - Application de gestion des temps de travail avec scanner QR Code">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="TimeSheet App">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>TimeSheet App</title>
  <link rel="manifest" href="manifest.json">

  <!-- Configuration optimisée pour la caméra et HTTPS -->
  <meta name="permissions-policy" content="camera=*, microphone=*, geolocation=*">
  
  <!-- Configuration de sécurité pour la caméra -->
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="unsafe-none">
  <meta http-equiv="Cross-Origin-Opener-Policy" content="unsafe-none">
  
  <!-- Forcer HTTPS pour la caméra -->
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <!-- Configuration PWA pour la caméra -->
  <meta name="theme-color" content="#667eea">
  <meta name="msapplication-TileColor" content="#667eea">

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .loading-container {
      text-align: center;
    }

    .spinner {
      width: 80px;
      height: 80px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    h1 {
      margin: 0 0 10px 0;
      font-size: 2.5em;
    }

    p {
      margin: 0;
      font-size: 1.2em;
      opacity: 0.9;
    }

    .error {
      display: none;
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }

    .error button {
      background: white;
      color: #667eea;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      margin-top: 15px;
    }

    .error button:hover {
      background: #f0f0f0;
    }

    #flutter-app {
      display: none;
      width: 100%;
      height: 100vh;
    }

    /* Styles pour les messages de permission caméra */
    .camera-permission {
      display: none;
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
      text-align: center;
    }

    .camera-permission button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.1em;
      margin: 10px;
    }

    .camera-permission button:hover {
      background: #45a049;
    }

    /* Styles pour les messages HTTPS */
    .https-warning {
      display: none;
      background: rgba(255,193,7,0.2);
      border: 1px solid #ffc107;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
      text-align: center;
    }

    .https-warning button {
      background: #ffc107;
      color: #000;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.1em;
      margin: 10px;
    }

    .https-warning button:hover {
      background: #e0a800;
    }
  </style>
</head>
<body>
  <!-- Écran de chargement -->
  <div id="loading" class="loading-container">
    <div class="spinner"></div>
    <h1>TimeSheet App</h1>
    <p>Chargement en cours...</p>
    
    <!-- Message d'erreur (caché par défaut) -->
    <div id="error" class="error">
      <h3>Erreur de chargement</h3>
      <p>L'application n'a pas pu démarrer. Vérifiez votre connexion internet et réessayez.</p>
      <button onclick="location.reload()">Réessayer</button>
    </div>

    <!-- Message de permission caméra (caché par défaut) -->
    <div id="camera-permission" class="camera-permission">
      <h3>Permission Caméra Requise</h3>
      <p>Pour utiliser le scanner QR Code, l'application a besoin d'accéder à votre caméra.</p>
      <button onclick="requestCameraPermission()">Autoriser la Caméra</button>
      <button onclick="location.reload()">Recharger</button>
    </div>

    <!-- Avertissement HTTPS (caché par défaut) -->
    <div id="https-warning" class="https-warning">
      <h3>⚠️ HTTPS Requis pour la Caméra</h3>
      <p>La caméra nécessite une connexion sécurisée (HTTPS) pour fonctionner.</p>
      <p>Veuillez utiliser l'URL HTTPS de l'application.</p>
      <button onclick="redirectToHttps()">Utiliser HTTPS</button>
      <button onclick="location.reload()">Recharger</button>
    </div>
  </div>

  <!-- Conteneur Flutter (caché pendant le chargement) -->
  <div id="flutter-app"></div>

  <!-- Script Flutter avec configuration optimisée pour la caméra et HTTPS -->
  <script src="flutter.js" defer></script>
  <script>
    // Configuration Flutter Web optimisée pour la caméra et HTTPS
    window.addEventListener('load', function() {
      console.log('Page chargée, démarrage de Flutter...');
      
      // Vérifier HTTPS avant de démarrer
      if (!isHttps()) {
        showHttpsWarning();
        return;
      }
      
      // Vérifier les permissions caméra avant de démarrer Flutter
      checkCameraPermissions();
      
      // Délai de sécurité pour s'assurer que Flutter est prêt
      setTimeout(function() {
        try {
          // Vérifier que Flutter est disponible
          if (typeof _flutter !== 'undefined' && _flutter.loader) {
            console.log('Flutter détecté, démarrage...');
            
            // Démarrer Flutter avec configuration simple (sans serviceWorker)
            _flutter.loader.loadEntrypoint({
              onEntrypointLoaded: function(engineInitializer) {
                console.log('Entrypoint chargé, initialisation...');
                
                engineInitializer.initializeEngine().then(function(appRunner) {
                  console.log('Moteur initialisé, démarrage de l\'app...');
                  
                  // Masquer le chargement et afficher l'app
                  document.getElementById('loading').style.display = 'none';
                  document.getElementById('flutter-app').style.display = 'block';
                  
                  // Démarrer l'application
                  appRunner.runApp();
                  
                  console.log('Application démarrée avec succès !');
                }).catch(function(error) {
                  console.error('Erreur lors de l\'initialisation du moteur:', error);
                  showError('Erreur lors de l\'initialisation du moteur');
                });
              }
            });
          } else {
            console.error('Flutter non détecté');
            showError('Flutter n\'est pas disponible');
          }
        } catch (error) {
          console.error('Erreur lors du démarrage:', error);
          showError('Erreur lors du démarrage de l\'application');
        }
      }, 2000); // Délai de 2 secondes pour GitHub Pages
    });

    // Fonction pour vérifier HTTPS
    function isHttps() {
      return window.location.protocol === 'https:' || 
             window.location.hostname === 'localhost' ||
             window.location.hostname === '127.0.0.1';
    }

    // Fonction pour rediriger vers HTTPS
    function redirectToHttps() {
      const currentUrl = window.location.href;
      const httpsUrl = currentUrl.replace('http:', 'https:');
      window.location.href = httpsUrl;
    }

    // Fonction pour afficher l'avertissement HTTPS
    function showHttpsWarning() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('https-warning').style.display = 'block';
    }

    // Fonction pour vérifier les permissions caméra
    function checkCameraPermissions() {
      if (navigator.permissions && navigator.permissions.query) {
        navigator.permissions.query({name: 'camera'}).then(function(result) {
          console.log('Permission caméra:', result.state);
          if (result.state === 'denied') {
            showCameraPermission();
          }
        });
      }
    }

    // Fonction pour demander la permission caméra
    function requestCameraPermission() {
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({video: true})
          .then(function(stream) {
            console.log('Caméra autorisée !');
            stream.getTracks().forEach(track => track.stop());
            document.getElementById('camera-permission').style.display = 'none';
            location.reload();
          })
          .catch(function(error) {
            console.error('Erreur permission caméra:', error);
            showError('Impossible d\'accéder à la caméra. Vérifiez les permissions du navigateur.');
          });
      } else {
        showError('Votre navigateur ne supporte pas l\'accès à la caméra.');
      }
    }

    // Fonction pour afficher les erreurs
    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      document.querySelector('#error p').textContent = message;
    }

    // Fonction pour afficher la demande de permission caméra
    function showCameraPermission() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('camera-permission').style.display = 'block';
    }

    // Gestion des erreurs globales
    window.addEventListener('error', function(e) {
      console.error('Erreur JavaScript:', e.error);
      showError('Erreur JavaScript détectée');
    });

    // Gestion des promesses rejetées
    window.addEventListener('unhandledrejection', function(e) {
      console.error('Promesse rejetée:', e.reason);
      showError('Erreur de promesse détectée');
    });
  </script>
</body>
</html>
